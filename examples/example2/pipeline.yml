- name: terraform-docs-updater
  plan:
  - put: new-branch 
    resource: bitbucket
    params:
      command: makebranch
      new_branch: "feature/update-tf-docs"
      from_branch: "master"
      reponame: "my-tf-module"
      repoproject: "TERRA"
  - get: scripts
  - put: apply-tf-docs 
    resource: bitbucket
    params:
      command: pullchangepush
      branch: "feature/update-tf-docs"
      reponame: "my-tf-module"
      repoproject: "TERRA"
      script_file: "scripts/tf_docs.sh"
      commit_message: "Running a script to update the TF Docs." 
  - put: pullrequest 
    resource: bitbucket
    params:
      command: pullrequest
      from_branch: "feature/update-tf-docs"
      to_branch: "master"
      reponame: "my-tf-module"
      repoproject: "TERRA"
      pr_title: "PR to update the TF Docs within this repo."
      pr_description: "This pull request was generated by concourse." #optional
      delete_if_no_changes: false
      reviewers:
        - myusername
        - thatusername
        - yourusername

resources:
  - name: scripts
    icon: git
    type: git
    source:
      branch: main
      uri: ssh://somewhere.com/project/scripts_repo.git
      private_key: (( secret_key ))

  - name: bitbucket-mgmt
    icon: cog
    type: bitbucket-branch-mgmt-resource
    source:
      bitbucket_url: "https://mycompany.com/"
      access_token: (( secret_access_token ))


resource_types:
  - name: bitbucket-branch-mgmt-resource
    type: registry-image
    source:
      repository: thehandsomezebra/bitbucket-branch-mgmt-resource
      tag: latest      